<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kamera + 3D Grid</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: sans-serif;
        }
        
        /* Kamera Görüntüsü (Arka Plan) */
        #camera-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ekranı doldur */
            z-index: 0;
            display: none; /* Başlangıçta gizli */
        }

        /* 3D Canvas (Ön Plan) */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1; /* Videonun üzerinde */
            display: block;
        }

        /* Başlatma Ekranı */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999; /* En üstte */
            color: white;
            text-align: center;
        }

        #start-btn {
            padding: 20px 50px;
            font-size: 20px;
            background-color: #00ff00;
            color: black;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            text-transform: uppercase;
        }
        
        #error-msg {
            color: red;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>

    <video id="camera-video" autoplay playsinline muted></video>

    <div id="overlay">
        <h1>KAMERA AR MODU</h1>
        <p>Kamera ve Hareket İzni İstenecek</p>
        <button id="start-btn">BAŞLAT</button>
        <p id="error-msg"></p>
    </div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.126.0/build/three.module.js';
        import { DeviceOrientationControls } from 'https://unpkg.com/three@0.126.0/examples/jsm/controls/DeviceOrientationControls.js';

        const startBtn = document.getElementById('start-btn');
        const overlay = document.getElementById('overlay');
        const videoElement = document.getElementById('camera-video');
        const errorMsg = document.getElementById('error-msg');

        let camera, scene, renderer, controls;

        // --- BUTONA TIKLANINCA ---
        startBtn.addEventListener('click', async () => {
            try {
                // 1. Kamera İzni İste
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment' // Arka kamerayı zorla
                    } 
                });
                
                // Videoyu başlat
                videoElement.srcObject = stream;
                videoElement.style.display = 'block';
                videoElement.play();

                // 2. Jiroskop İzni İste (iOS 13+ için)
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error('Hareket izni verilmedi.');
                    }
                }

                // Her şey tamamsa arayüzü gizle ve 3D'yi başlat
                overlay.style.display = 'none';
                init3D();

            } catch (err) {
                console.error(err);
                errorMsg.style.display = 'block';
                errorMsg.innerText = "Hata: " + err.message + "\n(Lütfen HTTPS kullanın ve izin verin)";
            }
        });

        function init3D() {
            // SAHNE
            scene = new THREE.Scene();
            // Arkaplanı tamamen şeffaf yapıyoruz ki videoyu görelim
            scene.background = null; 

            // KAMERA
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 0.1);

            // RENDERER
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); // Alpha:true çok önemli (şeffaflık)
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // KONTROLLER (Telefon Hareketi)
            controls = new DeviceOrientationControls(camera);

            // OBJE (IZGARA KUTU)
            // Daha büyük ve belirgin bir ızgara
            const geometry = new THREE.BoxGeometry(40, 40, 40, 10, 10, 10);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00ff00, // Yeşil renk daha "Matrix" havası verir, daha iyi görünür
                wireframe: true,
                transparent: true,
                opacity: 0.8
            });
            const room = new THREE.Mesh(geometry, material);
            material.side = THREE.BackSide; // İçindeyiz
            scene.add(room);

            // Responsive Ayarı
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if(controls) controls.update();
            renderer.render(scene, camera);
        }

    </script>
</body>
</html>
