<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GTA Web Simülasyonu - Düzeltilmiş Versiyon</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #87CEEB; font-family: sans-serif; user-select: none; -webkit-user-select: none; }
        
        /* Bilgilendirme Kutusu */
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            font-size: 14px;
        }

        /* --- MOBİL KONTROLLER (Başlangıçta gizli) --- */
        .mobile-ui {
            display: none; /* JS ile mobildeysek açılacak */
            position: absolute;
            z-index: 99;
        }

        /* Joystick Alanı */
        #joystick-zone {
            bottom: 30px;
            left: 30px;
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }

        #joystick-knob {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none; /* Dokunmayı zone algılasın */
        }

        /* Aksiyon Butonu (Araca Bin/İn) */
        #action-btn {
            bottom: 40px;
            right: 30px;
            width: 80px;
            height: 80px;
            background: rgba(0, 255, 0, 0.5);
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        #action-btn:active { background: rgba(0, 255, 0, 0.8); }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <div id="info">
        <b>Durum:</b> <span id="status">Yürüyor</span><br>
        <span id="pc-hint">PC: W,A,S,D ile gez, F ile bin/in.</span>
    </div>

    <div id="joystick-zone" class="mobile-ui">
        <div id="joystick-knob"></div>
    </div>
    <div id="action-btn" class="mobile-ui">BİN / İN</div>

    <script>
        // --- 1. SAHNE KURULUMU ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // Mavi gökyüzü (Siyah ekran olmasın diye)
        scene.fog = new THREE.Fog(0x87CEEB, 10, 100);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 500);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true; // Gölgeler açık
        document.body.appendChild(renderer.domElement);

        // Işıklar
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
        scene.add(hemiLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(50, 100, 50);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        // Zemin (Gridli - Yönü anlamak için)
        const groundGeo = new THREE.PlaneGeometry(500, 500);
        const groundMat = new THREE.MeshLambertMaterial({ color: 0x333333 });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        const gridHelper = new THREE.GridHelper(500, 50);
        scene.add(gridHelper);

        // --- 2. OYUNCU VE ARABA OLUŞTURMA ---

        // Oyuncu
        const player = new THREE.Group();
        const bodyGeo = new THREE.BoxGeometry(0.5, 1.7, 0.5);
        const bodyMat = new THREE.MeshStandardMaterial({ color: 0xff0000 }); // Kırmızı Adam
        const bodyMesh = new THREE.Mesh(bodyGeo, bodyMat);
        bodyMesh.position.y = 0.85;
        bodyMesh.castShadow = true;
        player.add(bodyMesh);
        scene.add(player);

        // Araba (Basit Geometri ile)
        const car = new THREE.Group();
        
        // Araba Gövde
        const carBody = new THREE.Mesh(
            new THREE.BoxGeometry(2, 0.5, 4),
            new THREE.MeshStandardMaterial({ color: 0x0000ff }) // Mavi Araba
        );
        carBody.position.y = 0.7;
        carBody.castShadow = true;
        car.add(carBody);

        // Araba Üst
        const carTop = new THREE.Mesh(
            new THREE.BoxGeometry(1.5, 0.6, 2),
            new THREE.MeshStandardMaterial({ color: 0xadd8e6 })
        );
        carTop.position.y = 1.3;
        carTop.position.z = -0.5;
        car.add(carTop);

        // Tekerlekler
        const wheelGeo = new THREE.CylinderGeometry(0.4, 0.4, 0.4, 16);
        const wheelMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
        const wheels = [];
        
        function addWheel(x, z) {
            const w = new THREE.Mesh(wheelGeo, wheelMat);
            w.rotation.z = Math.PI / 2;
            w.position.set(x, 0.4, z);
            car.add(w);
            wheels.push(w);
        }
        addWheel(-1.1, 1.2); addWheel(1.1, 1.2);
        addWheel(-1.1, -1.2); addWheel(1.1, -1.2);

        car.position.set(5, 0, 5); // Arabanın konumu
        scene.add(car);


        // --- 3. KONTROL MANTIĞI (MOBİL & PC ORTAK) ---
        
        let inputs = { x: 0, y: 0, action: false }; // x: dönüş, y: ileri/geri
        let gameState = {
            mode: 'walking', // walking veya driving
            rotation: 0,
            speed: 0,
            camDist: 5,
            camHeight: 3
        };

        // Klavye Dinleyici (PC İçin)
        const keys = { w: false, a: false, s: false, d: false };
        window.addEventListener('keydown', (e) => {
            const k = e.key.toLowerCase();
            if(keys.hasOwnProperty(k)) keys[k] = true;
            if(k === 'f') toggleVehicle();
        });
        window.addEventListener('keyup', (e) => {
            const k = e.key.toLowerCase();
            if(keys.hasOwnProperty(k)) keys[k] = false;
        });

        // Mobil Tespiti ve UI Gösterimi
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 800;
        
        if(isMobile) {
            document.querySelectorAll('.mobile-ui').forEach(el => el.style.display = 'flex');
            document.getElementById('pc-hint').style.display = 'none';
        }

        // --- JOYSTICK MANTIĞI ---
        const joyZone = document.getElementById('joystick-zone');
        const joyKnob = document.getElementById('joystick-knob');
        let joyTouchId = null;
        let joyCenter = { x: 0, y: 0 };

        joyZone.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.changedTouches[0];
            joyTouchId = touch.identifier;
            const rect = joyZone.getBoundingClientRect();
            joyCenter = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
            updateJoystick(touch.clientX, touch.clientY);
        }, {passive: false});

        joyZone.addEventListener('touchmove', (e) => {
            e.preventDefault();
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === joyTouchId) {
                    updateJoystick(e.changedTouches[i].clientX, e.changedTouches[i].clientY);
                    break;
                }
            }
        }, {passive: false});

        function endJoystick() {
            joyTouchId = null;
            joyKnob.style.transform = `translate(-50%, -50%)`;
            inputs.x = 0; 
            inputs.y = 0;
        }

        joyZone.addEventListener('touchend', endJoystick);
        joyZone.addEventListener('touchcancel', endJoystick);

        function updateJoystick(clientX, clientY) {
            let dx = clientX - joyCenter.x;
            let dy = clientY - joyCenter.y;
            const maxDist = 40;
            const dist = Math.min(Math.sqrt(dx*dx + dy*dy), maxDist);
            const angle = Math.atan2(dy, dx);
            
            // Görsel güncelleme
            const knobX = Math.cos(angle) * dist;
            const knobY = Math.sin(angle) * dist;
            joyKnob.style.transform = `translate(calc(-50% + ${knobX}px), calc(-50% + ${knobY}px))`;

            // Input güncelleme (-1 ile 1 arası)
            inputs.x = knobX / maxDist; // Sağa sola dönüş
            inputs.y = -(knobY / maxDist); // İleri geri (Yukarı eksi olduğu için ters çevir)
        }

        // Aksiyon Butonu (Mobil)
        document.getElementById('action-btn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            toggleVehicle();
        });


        // --- 4. OYUN FONKSİYONLARI ---

        function toggleVehicle() {
            if(gameState.mode === 'walking') {
                const dist = player.position.distanceTo(car.position);
                if(dist < 5) {
                    gameState.mode = 'driving';
                    player.visible = false;
                    document.getElementById('status').innerText = "Araba Sürülüyor";
                }
            } else {
                gameState.mode = 'walking';
                player.position.copy(car.position);
                player.position.x += 2.5; // Arabanın yanına in
                player.visible = true;
                gameState.speed = 0; // İnerken arabayı durdur
                document.getElementById('status').innerText = "Yürüyor";
            }
        }

        // --- 5. OYUN DÖNGÜSÜ ---
        function animate() {
            requestAnimationFrame(animate);

            // Girdi Birleştirme (Klavye + Joystick)
            let moveInput = inputs.y;
            let turnInput = -inputs.x; // Three.js rotasyonu ters çalışabilir

            if(!isMobile) {
                if(keys.w) moveInput = 1;
                if(keys.s) moveInput = -1;
                if(keys.a) turnInput = 1;
                if(keys.d) turnInput = -1;
            }

            // --- YÜRÜME MODU ---
            if(gameState.mode === 'walking') {
                if(Math.abs(moveInput) > 0.1) {
                    player.translateZ(moveInput * 0.15);
                    // Yürürken animasyon efekti (zıplama)
                    player.children[0].position.y = 0.85 + Math.sin(Date.now() * 0.01) * 0.05;
                }
                if(Math.abs(turnInput) > 0.1) {
                    player.rotation.y += turnInput * 0.05;
                }

                // Kamera Takibi
                const relativeCamOffset = new THREE.Vector3(0, 4, 6);
                const camPos = relativeCamOffset.applyMatrix4(player.matrixWorld);
                camera.position.lerp(camPos, 0.1);
                camera.lookAt(player.position);
            }

            // --- SÜRÜŞ MODU ---
            else if(gameState.mode === 'driving') {
                // Gaz / Fren
                if(moveInput > 0.1) gameState.speed += 0.01;
                else if(moveInput < -0.1) gameState.speed -= 0.01;
                else gameState.speed *= 0.98; // Sürtünme

                // Max Hız Sınırı
                gameState.speed = Math.max(Math.min(gameState.speed, 0.8), -0.3);

                // Direksiyon (Sadece hareket ederken döner)
                if(Math.abs(gameState.speed) > 0.01 && Math.abs(turnInput) > 0.1) {
                    car.rotation.y += turnInput * 0.03 * (gameState.speed > 0 ? 1 : -1);
                    
                    // Tekerlek dönüşü
                    wheels[0].rotation.y = turnInput * 0.5;
                    wheels[1].rotation.y = turnInput * 0.5;
                } else {
                    wheels[0].rotation.y = 0;
                    wheels[1].rotation.y = 0;
                }

                // Arabayı ilerlet
                car.translateZ(gameState.speed);

                // Kamera Takibi (Daha uzak ve esnek)
                const relativeCamOffset = new THREE.Vector3(0, 6, 10);
                const camPos = relativeCamOffset.applyMatrix4(car.matrixWorld);
                camera.position.lerp(camPos, 0.08); // Araba kamerasında biraz daha gecikme (gerçekçilik)
                camera.lookAt(car.position);
            }

            renderer.render(scene, camera);
        }

        // Ekran Boyutu Değişirse
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Başlat
        animate();

    </script>
</body>
</html>
